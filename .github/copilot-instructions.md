# Stödlinjer.se — AI Coding Agent Instructions

## Project Overview

**Stödlinjer.se** is a Swedish mental health support aggregator and information platform. It surfaces 21+ crisis hotlines, evidence-based articles, and an AI chatbot—helping people find the right help quickly. Built as a static site with Eleventy + Nunjucks, styled with Tailwind CSS, deployed on Vercel.

**Core mission:** Make Swedish support resources discoverable, searchable, and actionable for people in crisis and those supporting them.

---

## Architecture & Key Components

### Static Site Generation (Eleventy)
- **Eleventy 3.x** with Nunjucks templates (`src/_includes/`)
- **Build pipeline:** `npm run serve` (watch mode) → `npm run build` (production)
- Compiles Markdown articles + JSON data into static HTML in `site/`
- **Path prefix support:** `ELEVENTY_PATH_PREFIX` env var for subdir deployment

### Data Model (Single Source of Truth)
All content lives in JSON + Markdown frontmatter, no database:

1. **Support Lines** (`src/_data/supportData.json` → referred to as `support-lines.json` in docs)
   - Array of crisis hotlines with phone, chat, web contact options
   - Fields: `id`, `title`, `category`, `tags`, `availability`, `active`, `lastVerified`
   - Categories: `psykisk-halsa`, `barn-unga`, `vald`, `missbruk`, `aldre`, `anhoriga`, `ovrigt`
   - Reused for homepage grid + chatbot training data

2. **Articles** (`src/artiklar/**/*.md`)
   - Grouped into "samlingar" (collections): fakta-myter, FAQ, handlingsguider, samtalsstöd, fordjupning
   - Frontmatter: `title`, `description`, `date`, `samling`, `tags`, optional `readingTime`
   - Rendered via `layouts/post.njk`, linked from collection pages

3. **Site Metadata** (`src/_data/site.json`, `chatbot.json`, `quotes.json`)
   - Global config (language, theme color, analytics)
   - Chatbot greetings + API endpoint

### Build & Content Index
- **Tailwind build:** `npm run build:css` → `src/assets/css/tailwind-built.css`
- **Content index for chatbot:** `npm run index:content` → `.chatdata/content-index.json`
  - Generated by `scripts/generate-content-index.js` before each build
  - Flattens all support lines + articles into searchable JSON
  - Used by chatbot to cite sources and ground answers

### Frontend Patterns
- **Icon system** (`src/assets/js/app.js`): Dual SVG sprites (line + solid variants) loaded from `/data/icons.json`
- **Theme toggle:** Light/dark mode via CSS variables, respects `prefers-color-scheme`
- **Search:** URL-based (`?q=term`), schema.org SearchAction for site search
- **Chatbot** (`src/assets/js/chatbot.js`): Posts to `/.netlify/functions/chat` (or Vercel equivalent)

---

## Critical Developer Workflows

### Local Development
```bash
npm install              # Install dependencies
npm run serve            # Start dev server (Tailwind watch + Eleventy at :8080)
npm run build:css        # Rebuild Tailwind only
npm run build            # Build full site to site/
npm run index:content    # Regenerate chatbot content index
npm run clean            # Remove site/ folder
```

**Common patterns:**
- Modify articles in `src/artiklar/` — Eleventy auto-rebuilds
- Add support lines: edit `src/_data/supportData.json`, rebuild
- Update chatbot knowledge: run `npm run index:content && npm run build`
- CSS changes: Tailwind auto-compiles; PostCSS handles imports + autoprefixes

### Deployment
- **Vercel:** Pushes to main → auto-deploy via vercel.json
- **Environment variables:** `ELEVENTY_PATH_PREFIX` (for subdir), `OPENAI_API_KEY` (chatbot only)
- **Pre-deploy checklist:** `npm run index:content && npm run build && npm run clean`

---

## Nunjucks Template Patterns

- **Layouts:** `base.njk` (global shell), `post.njk` (article wrapper)
- **Partials:** `header.njk`, `footer.njk`, `chatbot.njk`, `article-card.njk`, `sections.njk`
- **Filters** (eleventy.config.js):
  - `formatDate` → Swedish locale (sv-SE)
  - `markdownify` / `markdownifyInline` → convert Markdown to HTML
  - `readingTime` → word count → reading minutes
  - `getSamling(slug)` → lookup samling metadata
  - `json` → stringify for inline data
- **Global data:** `collections.articles`, `collections.samlingar`, `baseUrl` (path prefix)

**Key detail:** Partials receive full data context; use `{{ item.data.field }}` for nested Eleventy collections.

---

## JSON Data Patterns

### Support Line Object (from `supportData.json`)
```json
{
  "id": 1,
  "title": "Självmordslinjen",
  "resource": { "url": "https://...", "type": "link" },
  "contactTypes": ["telefon", "chatt", "webb"],
  "phone": "90101",
  "description": "För dig med suicidtankar...",
  "category": "psykisk-halsa",
  "urgent": true,
  "tags": ["akut", "psykisk-halsa"],
  "availability": {
    "label": "Dygnet runt, årets alla dagar",
    "timezone": "Europe/Stockholm",
    "openingHours": [
      {
        "days": ["mon","tue",...],
        "open": "00:00",
        "close": "24:00",
        "channels": ["telefon","chatt"]
      }
    ]
  },
  "lastVerified": "2025-12-10",
  "active": true
}
```

### Samling Object (collection metadata)
```json
{
  "slug": "fakta-myter",
  "title": "Fakta vs Myter",
  "summary": "Korta fakta som motbevisar vanliga myter",
  "icon": "fa-lightbulb"
}
```

---

## Chatbot System (`api/chat.js`)

- **Endpoint:** `POST /.netlify/functions/chat` (Netlify) or Vercel equivalent
- **Request:** `{ message: string }`
- **Response:** `{ reply: string, sources: [{type, title, url}] }`
- **LLM:** OpenAI (requires `OPENAI_API_KEY`)
- **Context:** Chatbot uses `.chatdata/content-index.json` to ground answers and cite support lines / articles
- **Tone:** Swedish, warm, empathetic but direct. For crisis (suicidal ideation, violence, acute panic), chatbot instructs users to call hotlines or 112.
- **System prompt** (in `api/chat.js`): Sets identity as support assistant, not therapist. Defines crisis response rules.

**To regenerate chatbot knowledge** after content changes: `npm run index:content`

---

## Common Pitfalls & Conventions

1. **Always check `active: true`** when listing support lines — inactive lines should be filtered in UI and chatbot index.
2. **Samling slugs are canonical.** Article frontmatter must match exactly (e.g., `samling: fakta-myter`). Mismatch = article won't appear in collection.
3. **Markdown filenames must be ISO dates:** `YYYY-MM-DD-slug.md`. Used for sorting and post dating.
4. **Icon aliases** are in `/data/icons.json`, not hardcoded. Update there if adding new icons.
5. **Swedish locale in dates:** Filters use `sv-SE`; don't hardcode English month names.
6. **CSS entry point:** Only import Tailwind in `src/assets/css/tailwind.css`; don't create separate stylesheets.
7. **JavaScript modules:** Entry points are `app.js` (UI) and `chatbot.js` (bot). Both loaded in `base.njk`.
8. **Content index generation is automatic:** Eleventy runs `generateContentIndex()` in the `eleventy.before` hook. For local testing, run `npm run index:content` manually.

---

## File Structure Reference

```
src/
  _data/              ← JSON datasets (supportData, samlingar, quotes, chatbot, site)
  _includes/
    layouts/          ← base.njk, post.njk
    partials/         ← reusable components (header, footer, sections, etc.)
  assets/
    css/              ← tailwind.css (entry), tailwind-built.css (output), base.css
    js/               ← app.js (UI), chatbot.js (bot UI)
    icons/            ← SVG symbol sprites
    fonts/
  artiklar/           ← Article .md files organized by samling subfolder
  index.njk, kontakt.njk, samlingar.njk    ← Main pages
.chatdata/            ← Generated content index (don't edit)
docs/                 ← Developer guides (00-index.md to start)
scripts/
  generate-content-index.js  ← Builds .chatdata/content-index.json from all data + articles
api/chat.js           ← Chatbot endpoint
vercel.json, eleventy.config.js, tailwind.config.js, postcss.config.js  ← Config files
```

---

## When Modifying Content

- **Adding/editing a support line:** Edit `src/_data/supportData.json` → rebuild (`npm run build`)
- **Adding/editing an article:** Create `src/artiklar/{samling}/{YYYY-MM-DD-slug}.md` with frontmatter → rebuild
- **Updating chatbot knowledge:** After content changes, run `npm run index:content` (auto-runs on `npm run build`)
- **Styling changes:** Edit Tailwind classes in templates; rebuild CSS with `npm run build:css`
- **Layout/template changes:** Edit `.njk` files; Eleventy recompiles on save in watch mode

---

## Questions to Ask Yourself

When working on features, ask:
1. **Is this a static site?** (Yes—no real-time data; changes require rebuild.)
2. **Does the chatbot need this?** (If so, add to `src/_data/` and regenerate index.)
3. **Is the URL structure correct?** (Eleventy collections use permalink patterns in `artiklar.json`.)
4. **Are all support lines marked `active: true`?** (Filtering happens frontend + chatbot.)
5. **Does this work in Swedish?** (Locale, timezone, string length—Swedish is longer than English.)

---

## Build, Deployment & Automation

- **CI/CD:** Vercel auto-deploys on push to `main` using `vercel.json`. No custom Netlify build steps; all build logic is in npm scripts and Eleventy hooks.
- **Pre-deploy best practice:** Always run `npm run index:content && npm run build && npm run clean` before pushing to production to ensure chatbot index and static output are up to date.
- **Environment variables:**
  - `ELEVENTY_PATH_PREFIX` for subdirectory deploys (set in Vercel/Netlify dashboard if needed)
  - `OPENAI_API_KEY` for chatbot (never commit this key)
- **No test suite:** There are no automated tests; manual QA is required for content and build output.

---

## Chatbot Error Handling & Moderation

- **Error handling:** The chatbot endpoint (`api/chat.js`) returns a generic error message if the OpenAI API fails or times out. No user PII is logged or stored.
- **Moderation:** The system prompt enforces crisis protocols (see above). For any message indicating acute risk (suicidal ideation, violence, panic), the bot must:
  - Respond empathetically and directly
  - Suggest immediate resources (hotlines, 112) if risk is present
  - Never attempt to diagnose or provide therapy
- **Abuse/spam:** There is no explicit abuse filter; moderation relies on the LLM’s system prompt and OpenAI’s built-in moderation.
- **Language:** Always reply in Swedish unless the user writes in English or requests another language.

---

## Project-Specific Pain Points & Gotchas

- **Data source confusion:** Only edit JSON in `src/_data/` and Markdown in `src/artiklar/`. Never edit `.chatdata/` or `site/` directly—these are generated.
- **Samling slugs:** Must match exactly between article frontmatter and `samlingar.json` or articles will not appear in collections.
- **Inactive support lines:** Always filter by `active: true` in both UI and chatbot index. Inactive lines are not shown or cited.
- **Date handling:** Use ISO date format in filenames and data. All date formatting in UI uses Swedish locale (`sv-SE`).
- **Icon system:** All icon aliases and paths are in `/data/icons.json`. Never hardcode icon SVGs in templates or JS.
- **No real-time updates:** All changes require a full rebuild and redeploy to be visible on the site.
